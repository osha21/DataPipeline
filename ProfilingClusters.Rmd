---
title: "ProfilingClusters"
output: html_document
---

eng <- read.csv("Engagement.csv")
agency <- read.csv("SenseofAgency.csv")

## compute averages (skip first column = participant ID)
eng$Engagement_Avg <- rowMeans(eng[, -1], na.rm = TRUE)
agency$Agency_Avg  <- rowMeans(agency[, -1], na.rm = TRUE)

## combine into dataframe
df <- data.frame(
  Participant = eng[[1]],
  Engagement  = eng$Engagement_Avg,
  Agency      = agency$Agency_Avg
)

## ---- K-MEANS CLUSTERING (k = 4) ----
set.seed(123)  # ensures reproducibility
k <- 4

cluster_model <- kmeans(df[, c("Engagement", "Agency")], centers = k)

## assign cluster labels
df$Cluster <- factor(cluster_model$cluster)

## plot clusters
library(ggplot2)
library(factoextra)
library(knitr)

#new
names(df)[names(df) == "Participant"] <- "player_id"


#elbow plot
#-------------------------------------------
data_kmeans <- df[, c("Engagement", "Agency")]

fviz_nbclust(data_kmeans, 
             kmeans, 
             method = "wss") +
  labs(
    title = "Elbow Method for Optimal Number of Clusters",
    x = "Number of Clusters (k)",
    y = "Within-Cluster Sum of Squares"
  ) +
  theme_minimal()

#-------------------------------------------


library(ggrepel)

ggplot(df, aes(x = Agency, y = Engagement, color = Cluster)) +
  geom_point(size = 3) +
  geom_text_repel(
    aes(label = player_id, color = Cluster),   # <-- color mapped to cluster
    size = 3,
    show.legend = FALSE                         # text color wonâ€™t clutter legend
  ) +
  geom_hline(yintercept = 3, linetype = "dashed") +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(1, 5) +
  ylim(1, 5) +
  labs(
    title = "Engagement vs Agency (4 K-means Clusters)",
    x = "Average Agency Score",
    y = "Average Engagement Score"
  ) +
  theme_minimal()
  
#------------------------------------------------------------------------------
#PCA


beh <- read.csv2("player_features_.csv", dec = ",", check.names = FALSE)

telemetry_vars <- beh[, c("mean_morality", "var_morality", "std_morality", "final_morality", "npc_interactions", "number_puzzles_started", "number_puzzles_succeeded", "number_puzzles_failed", "puzzle_success_rate", "average_time_spent_puzzles", "time_complete_game", "ending_achieved", "%_exploration", "%_puzzle", "%_moral_decisions", "state_entropy", "number_hotspots", "pct_time_in_hotspots", "peak_density_value")]



#standardize data

telemetry_scaled <- scale(telemetry_vars)

#PCA

pca_result <- prcomp(telemetry_scaled, center = FALSE, scale. = FALSE)
summary(pca_result)

#extract PC1 and PC2
scores <- as.data.frame(pca_result$x[, 1:2])
colnames(scores) <- c("PC1", "PC2")

scores$player_id <- beh$player_id

#elbow plot
#----------------------
set.seed(123)

# Compute total within-cluster sum of squares for k = 1 to 10
wss <- sapply(1:10, function(k) {
  kmeans(scores, centers = k, nstart = 20)$tot.withinss
})

# Plot Elbow
plot(1:10, wss, type = "b",
     xlab = "Number of clusters (k)",
     ylab = "Total within-cluster sum of squares",
     main = "Elbow Plot for PCA")
#----------------------

#K-means

km <- kmeans(scores[, c("PC1", "PC2")], centers = 3, nstart = 25)

scores$behavior_cluster <- factor(km$cluster)

#plot

ggplot(scores, aes(PC1, PC2, color = behavior_cluster, label = player_id)) +
  geom_point(size = 3) +
  geom_text(vjust = -0.6) +
  theme_minimal() +
  labs(
    title = "K-means Principle Component Analysis",
    x = "PC1",
    y = "PC2",
    color = "Cluster"
  )

#loadings
round(pca_result$rotation[, 1:2], 3)

#------------------------------------------------------------------------------
#compare

merged <- merge(df,scores[, c("player_id", "behavior_cluster")],by = "player_id")

tab <- table(merged$Cluster, merged$behavior_cluster)
kable(tab, caption = "Self-report Clusters (rows) vs Behavioral Clusters (columns)")


fisher.test(tab)


#Fisher's exact test used on the profile(2) with the most appearances in 
#behavior cluster 1

tab1 <- matrix(
  c(4, 7,
    4, 10),
  nrow = 2,
  byrow = TRUE
)

rownames(tab1) <- c("Profile_X", "Other_profiles")
colnames(tab1) <- c("In_cluster", "Not_in_cluster")

tab1

fisher.test(tab1, alternative = "greater")
